<app-post>
  <app-post-form class={'app-hidden': !editing}></app-post-form>
  <app-post-show class={'app-hidden': editing}></app-post-show>

  <script>
    var Dispatcher = require('../app/dispatcher')
    var Post = require('../app/post')

    show(data) {
      this.update({
        editing: false,
        post: (data ? new Post(data) : this.post)
      })
    }

    edit() {
      this.editing = true
      this.update()
    }

    editing = false
    post = new Post(opts.post)
  </script>
</app-post>

<app-post-show>
  <h2><i class='fa fa-play'></i>&nbsp;{post.title}</h2>

  <div class='post-show-embed'>
    <iframe if={post.embed.type == 'youtube'} type='text/html' width='640' height='260'
      src='http://www.youtube.com/embed/{post.embed.videoId}'
      frameborder='0'></iframe>
  </div>

  <p class='post-show-description'>
    {post.desc}
  </p>

  <div class='post-actions'>
    <a title='Favorite' href='#' onclick={toggleFav} class='{post-favorited: post.favorited}'><i class='fa fa-heart'></i>&nbsp;Favorite</a>
    <a title='Edit'     href='#' onclick={edit}><i class='fa fa-edit'></i>&nbsp;Edit</a>
    <a title='Remove'   href='#'><i class='fa fa-trash'></i>&nbsp;Remove</a>
  </div>

  <script>
    this.parent.on('update', function(){
      this.update({post: this.parent.post})
    }.bind(this))

    edit(ev) {
      this.parent.edit()
    }

    toggleFav(ev) {
      this.post.favorited = !this.post.favorited
    }
  </script>
</app-post-show>

<app-post-form>
  <form name='postForm'>
    <h2>Editing Post</h2>

    <p>
      Provide the resource url to share, a title and a description.
    </p>

    <div class='post-form-embed'>
      <label>Embed Url (e.g. YouTube Url)</label>
      <input name='embedUrl' type='url' value={post.embed.url} class={invalid: urlInvalid}
             placeholder='https://www.youtube.com/watch?v=P9J5tYShNY8' />
    </div>

    <div class='post-form-data'>
      <input name='postTitle' type='text' value={post.title} class={invalid: titleInvalid}
             title='Post Title' placeholder='Title' />
      <textarea name='postDescription' value={post.desc}
             title='Post Description' placeholder='Description' /></textarea>
    </div>

    <div class='post-actions'>
      <a title='Undo' onclick={undo} href='#'><i class='fa fa-times-circle'></i>&nbsp;Cancel</a>
      <a title='Save and Publish' onclick={publish} href='#'><i class='fa fa-save'></i>&nbsp;Save</a>
      <span class='post-edit-message' name='msg'>{editMessage}</span>
    </div>
  </form>

  <script>
    this.parent.on('update', function(){
      this.update({post: this.parent.post})
    }.bind(this))

    message(msg) {
      this.msg.innerText = msg
    }

    undo(ev) {
      this.parent.show()
    }

    publish(ev) {
      var values = require('lodash/object/values')
      var Post = require('../app/post')

      var newPost = new Post(this.post).update({
        title: this.postTitle.value,
        desc: this.postDescription.value,
        embed: {url: this.embedUrl.value}
      })

      var result = newPost.validationResult()

      if (result.isValid) {
        this.parent.show(newPost)
      } else {
        var msg = values(result.errors).join(', ')
        this.urlInvalid = !!result.errors.url
        this.titleInvalid = !!result.errors.title
        this.message('Sorry, the post can\'t be saved: ' + msg + '.')
      }
    }
  </script>
</app-post-form>
