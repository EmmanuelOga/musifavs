<app-user>
  <div class='flex-content-wrapper'>

    <aside class='profile'>
      <div class='profile-info'>
        <ul class='fa-ul'>
          <li class='profile-pic'>
            <img src={user.avatarUrl} />
          </li>
          <li>
            <i class='fa-li fa fa-link'></i>
            <a href="{user.url}">{user.displayName}</a><br>
          </li>

          <li>
            <i class='fa-li fa fa-user'></i>
            {user.description}
          </li>

          <li>
            <i class='fa-li fa fa-map-marker'></i>
            {user.location}
          </li>

          <li>
            <i class='fa-li fa fa-twitter-square'></i>
            <a href="https://twitter.com/{user.displayName}">@{user.displayName}</a>
          </li>

          <li>
            Displaying {this.posts.length} Posts
          </li>
        </ul>
      </div>
    </aside>

    <main class='main' role='main'>
      <app-post if={newPost} post={newPost}></app-post>

      <div if={!newPost && posts.length === 0} class='post-placeholder'>
        <h1>Hey!&nbsp;<i class='fa fa-child'></i>&nbsp;<i class='fa fa-play'></i></h1>
        <p>
          This user has not posted anything yet. Please check back later!
        </p>
      </div>

      <app-post class='app-post' each={post, i in posts} post={post}></app-post>
    </main>
  </div>

  <script>
    var c, disp = require('../lib/dispatcher')

    this.posts = []
    this.newPost = null

    this.on('unmount', function() { c.destroy() })

    this.on('mount', function() {
      c = disp.context()

      c.on('store:users:failed:lookup', function(uid) {
        c.trigger('module:user:failed:mount', uid)
      })

      c.on('store:users:did:lookup', function(uid, user) {
        c.trigger('store:posts:do:retrieve', uid)
        this.update({user: user})
      }.bind(this))

      c.on('store:posts:did:retrieve', function(post){
        this.posts.unshift(post)
        this.update()
      }.bind(this))

      c.on('store:posts:did:destroy', function(post) {
        var reject = require('lodash/collection/reject')
        var posts = reject(posts, function(post){ return post.key == key })
        this.update({posts: posts})
      }.bind(this))

      c.on('user:newpost', function(user) {
        this.update({newPost: new Post()})
      }.bind(this))

      c.on('module:user:do:cancelcreatepost', function() {
        this.update({newPost: null})
      }.bind(this))
    })

    this.on('unmount', function() {
      if (this.user) {
        c.trigger('store:posts:do:stopretrieve', this.user.uid)
      }
    })

    this.on('mount', function() {
      c.trigger('store:users:do:lookup', opts.uid)
    })

  </script>
</app-user>
