<app-post-form>
  <form name='postForm'>
    <h2>{this.post.isPersisted ? 'Editing Post' : 'New Post'}</h2>

    <p>
      Provide the resource url to share, a title and a description.
    </p>

    <div class='post-form-embed'>
      <label>Embed Url (e.g. YouTube Url)</label>
      <input name='embedUrl' type='url' value={post.embed.url} class={invalid: urlInvalid}
             placeholder='https://www.youtube.com/watch?v=P9J5tYShNY8' />
    </div>

    <div class='post-form-data'>
      <input name='postTitle' type='text' value={post.title} class={invalid: titleInvalid}
             title='Post Title' placeholder='Title' />
      <textarea name='postDescription' value={post.desc}
             title='Post Description' placeholder='Description' /></textarea>
    </div>

    <div class='post-actions'>
      <a title='Undo' onclick={undo} href='#'><i class='fa fa-times-circle'></i>&nbsp;Cancel</a>
      <a title='Save and Publish' onclick={publish} href='#'><i class='fa fa-save'></i>&nbsp;Save</a>
      <span class='post-edit-message' name='msg'>{editMessage}</span>
    </div>
  </form>

  <script>
    var values = require('lodash/object/values')
    var Post = require('../app/post')

    var c, disp = require('../lib/dispatcher')

    this.on('unmount', function() { c.destroy() })

    this.on('mount', function() {
      c = disp.context()
    })

    this.post = opts.post

    this.on('mount', function(){
      console.log('form mounted')
    })

    this.on('unmount', function(){
      console.log('form unmounted')
    })

    this.on('update', function(){
      // Hack: riot should reset these values...
      if (!this.post.isPersisted) {
        this.postTitle.value = ''
        this.postDescription.value = ''
        this.embedUrl.value = ''
      }
    }.bind(this))

    message(msg) {
      this.msg.innerText = msg
    }

    undo(ev) {
      var page = require('page')

      if (this.post.isPersisted) {
        // Hack: riot should reset these values...
        this.postTitle.value = this.post.title
        this.postDescription.value = this.post.desc
        this.embedUrl.value = this.post.embed.url
        this.parent.show()
      } else {
        c.trigger('user:cancelcreatepost')
        page.redirect('/posts')
      }
    }

    publish(ev) {
      var newPost = new Post(this.post).setAttributes({
        title: this.postTitle.value,
        desc: this.postDescription.value,
        embed: {url: this.embedUrl.value}
      })

      var result = newPost.validationResult()

      if (result.isValid) {
        if (this.post.isPersisted) {
          newPost.save()
          this.parent.show(newPost)
        } else {
          newPost.create()
          c.trigger('user:cancelcreatepost', newPost)
        }
      } else {
        var msg = values(result.errors).join(', ')
        this.urlInvalid = !!result.errors.url
        this.titleInvalid = !!result.errors.title
        this.message('Sorry, the post can\'t be saved: ' + msg + '.')
      }
    }
  </script>
</app-post-form>
