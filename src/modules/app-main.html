<app-main>
  <div id='mountpoint' class='flex-content-wrapper'></div>

  <script>
    var riot = require('riot')
    var user = require('../app/user').current
    var c, disp = require('../lib/dispatcher')
    var Mounter = require('../lib/mounter')

    var m = new Mounter()

    function message(msg) {
      c.trigger('module:message:do:show', msg)
    }

    function route(_uid, action, postid) {
      var uid = (_uid == 'me') ? user.uid : _uid

      if (user.logged) {
        c.trigger('module:navigation:do:showlogout')
      } else {
        c.trigger('module:navigation:do:hidelogout')
      }

      switch(action) {
      case 'favorite':
        if (user.logged) {
          c.trigger('store:posts:do:favorite', uid, postid)
        } else {
          message('Please login to favorite posts.')
          m.display('#mountpoint', 'app-login')
        }

        break

      case 'new':
      case 'posts':
      case 'favorites':

        if (uid) {
          m.display('#mountpoint', 'app-user', {uid: uid, action: action})
        } else {
          message('Please login to access your posts.')
          m.display('#mountpoint', 'app-login')
        }

        break

      case 'logout':

        if (user.logged) {
          c.trigger('store:users:do:logout')
        } else {
          window.location.hash = ''
        }

        break

      default:
        m.display('#mountpoint', 'app-front')
      }
    }

    this.on('unmount', function() { c.destroy() })

    this.on('mount', function() {
      c = disp.context()

      c.on('store:users:did:login', function(user){
        message('Thank you! You have been logged in.')
        c.trigger('store:users:do:update', user)
      })

      c.on('store:users:did:update', function(user) {
        route(user.uid, 'posts') // "redirect" to the user posts screen.
      })

      c.on('store:users:did:logout', function(){
        message('You\'ve been logged out.')
        window.location.hash = '' // "redirect" home.
      })

      c.on('module:user:failed:mount', function(){
        message('Sorry, we could not find that user.')
        window.location.hash = '' // "redirect" home.
      })

      riot.route(route) // setup, doesn't run the routing function.
      riot.route.exec(route) // so run it :-)
    })
  </script>
</app-main>
